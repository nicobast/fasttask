---
title             : "Atypical Arousal Regulation indicates altered Locus Coeruleus Activity in Neurodevelopmental Disorders"
shorttitle        : "Arousal Regulation in Neurodevelopmental Disorders"
author: 
  - name          : "Nico Bast"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Postal address"
    email         : "nico.bast@kgu.com"
  - name          : "Sara Boxhoorn"
    affiliation   : "1"
affiliation:
  - id            : "1"
    institution   : "Department of Child and Adolescent Psychiatry, Goethe University Frankfurt"
authornote: |
  Department of Child and Adolescent Psychiatry, Psychosomatics and Psychotherapy, Autism Research and Intervention Center of Excellence, University Hospital Frankfurt, Goethe-University, 60528 Frankfurt am Main, Germany 
abstract: |
  Atypical arousal regulation may explain slower mean reaction time (MRT) in neurodevelopmental disorders like Autism Spectrum Disorder (ASD) and Attention-Deficit/Hyperactivity Disorder (ADHD) compared to typically developing controls (TD). The Locus Coeruleus â€“ Norepinephrine system (LC-NE) underlies arousal regulation and adapts its activity to the utility of a task. LC-NE tonic and phasic activity are indexed by baseline pupil size (BPS) and stimulus-evoked pupillary response (SEPR). To compare atypical arousal regulation between neurodevelopmental disorders, the present study assessed pupillometry during a visuospatial reaction time task in ASD- (n=18), ADHD- (n=28), ASD with comorbid ADHD (ASD+ADHD, n=13), and TD (n=31). We measured changes in BPS, SEPR, and MRT in high versus low task utility. Results showed attenuated changes in BPS in ASD- and ASD+ADHD compared to TD, and in ASD- compared to ADHD-. Changes in SEPR were additionally attenuated in ASD- relative to all groups, and in ADHD- compared to TD. MRT decrease - with increase in task utility - was larger in all clinical groups and largest in ASD+ADHD. Larger BPS and SEPR were associated with faster MRT during low task utility, and most pronounced in ASD+ADHD. Together, we characterized atypical arousal regulation to increase in task utility. In ASD as attenuated LC-NE tonic down- and phasic upregulation, which suggests an impaired sensory selectivity during exploitative processing. In ADHD as attenuated LC-NE phasic upregulation, which supports previous state-regulation-deficit accounts. Independent neurophysiological causes likely underlie atypical arousal regulation in ASD and ADHD but are associated with attenuated LC-NE activity adaption. 
  
  <!-- https://tinyurl.com/ybremelq -->
keywords          : "keywords"
wordcount         : "X"
bibliography      : ["r-references.bib"]
fontsize: 10pt
floatsintext      : no
figurelist        : yes
tablelist         : yes
footnotelist      : no
linenumbers       : no
mask              : no
draft             : no
documentclass     : "apa6"
classoption       : "man"
output            : 
    pdf_apa6: papaja::apa6_pdf
    html_document: default
    word_document: default
---

```{r setup, message=F}

## TO RUN THIS MARKDOWN TEX DISTRIBUTION AND PAPAJA package are required:

#install.packages('tinytex') # required to install Tinytex distribution within R (no R package)
#tinytex::install_tinytex() #installs a TeX distribution, TeX can be compiled to PDF, required by PAPAJA
#after installation, check whether 'tinytex:::is_tinytex()' returns TRUE

#PAPAJA is not on CRAN. Devtools (R package) is required to install papaja: devtools::install_github("crsh/papaja")
library(papaja) #provides template applied and apa ready tables

require(lme4) #linear mixed models
require(emmeans) #predicted marginalized means
require(lmerTest) #significance in LMM
require(ggplot2) #plottingo
require(gridExtra) #grid.arrange
require(grid) #textGrob
require(sjPlot) #plot.mdoel

###define number of models for n in Bonferroni correction 
number_of_models<-4

```

```{r analysis-preferences}
# Seed for random number generation
#set.seed(42)
#knitr::opts_chunk$set(cache.extra = knitr::rand_seed)

knitr::opts_chunk$set(cache = T)
knitr::opts_chunk$set(echo = F) #for word knit
knitr::opts_chunk$set(warning = F) #for word knit
knitr::opts_chunk$set(message = F) #for html knit: prevents r note:

```

```{r load_data}
setwd('C:/Users/Nico/PowerFolders/Paper_MINDdata_fasttask')
load('df_021019.Rdata')
```

```{r calculate_trial_aggregated_data}
#SELECT data from the overall data set:
df_valid<-df[df$gaze_valid & df$correct_response & 
               #df$currentTrial>10 & df$currentTrial<70 & 
               df$reaction_time<=1500 & df$reaction_time>=200,]

#selected interaction for per-trial analysis:
int_trial<-with(df_valid,interaction(id.label,currentTrial,typeGame))

factors_trial<-with(df_valid,aggregate(data.frame(groupASD,groupADHD,id.label,currentTrial,typeGame,age,sex,pIQ),
                                     by=list(int_trial),head,n=1))

metrics_mean_trial<-with(df_valid,aggregate(data.frame(tpd,rpd,reaction_time),
                                          by=list(int_trial),mean,na.rm=T))

metrics_sd_trial<-with(df_valid,aggregate(data.frame(tpd,rpd), 
                                        by=list(int_trial),sd,na.rm=T))
#note: on trial level no variation of reaction time can be calculated

#-- state specific data (strState) ###
metrics_fore_mean_trial<-with(df_valid[df_valid$strState=='foreperiod',],aggregate(data.frame(tpd,rpd),
                                    by=list(interaction(id.label,currentTrial,typeGame)),mean,na.rm=T))

metrics_stim_mean_trial<-with(df_valid[df_valid$strState=='stimuli',],aggregate(data.frame(tpd,rpd),
                                    by=list(interaction(id.label,currentTrial,typeGame)),mean,na.rm=T))

metrics_isi_mean_trial<-with(df_valid[df_valid$strState=='isi',],aggregate(data.frame(tpd,rpd),
                                    by=list(interaction(id.label,currentTrial,typeGame)),mean,na.rm=T))

  #relabel
  names(metrics_fore_mean_trial)[2:3]<-c('tpd_fore','rpd_fore')
  names(metrics_stim_mean_trial)[2:3]<-c('tpd_stim','rpd_stim')
  names(metrics_isi_mean_trial)[2:3]<-c('tpd_isi','rpd_isi')
  names(metrics_mean_trial)[2:4]<-c('tpd_m','rpd_m','rt_m')
  names(metrics_sd_trial)[2:3]<-c('tpd_sd','rpd_sd')
  
  ###MERGE several data.frame at once (Reduce, which is very fast)
  df_trial<-Reduce(function(x,y){merge(x = x, y = y, by = "Group.1", all.x=T)}, 
         list(factors_trial,metrics_mean_trial,metrics_sd_trial, 
              metrics_fore_mean_trial, metrics_stim_mean_trial, metrics_isi_mean_trial))
  
  ##create phasic response variable on trial level
  rpd_phasic<-with(df_trial,rpd_stim-rpd_fore)
  df_trial<-data.frame(df_trial,rpd_phasic)

  ##outlier correction (increase/decrease by more than 50%)
  df_trial$rpd_phasic[df_trial$rpd_phasic>0.5]<-NA
  df_trial$rpd_phasic[df_trial$rpd_phasic<(-0.5)]<-NA
  df_trial$rpd_fore[df_trial$rpd_fore>0.5]<-NA
  df_trial$rpd_fore[df_trial$rpd_fore<(-0.5)]<-NA
  
    #NOTE: TPD - global median corrected PD values, RPD - first 200ms of trial corrected values
    #TPD, RPD do not matter for the difference measure rpd_phasic, but TPD needs to be chosen
    # for BPS as otherwise, it would also be a change measure
  
  #with(df_trial,hist(rpd_phasic,100))
  #with(df_trial,hist(rt_m,50))
  
  #change typeGame levels to meaningful labels - for facet labelling in plotting
  levels(df_trial$typeGame)<-c('low-utility','high-utility')

```

# Methods
## Data analysis
We used `r cite_r("r-references.bib")` for all our analyses.

# Results

## Sample Descriptives

Sampel descriptives are reported in table 1.

```{r sample_descriptive_calculate}

#dependent variables descriptives (added 02.06.20, calculated from df_trial)

### tonic size (relative, rpd_fore)
rpd_fore_perID_lowUT<-as.numeric(with(df_trial[df_trial$typeGame=='low-utility',],by(rpd_fore,id.label,mean,na.rm=T)))
rpd_TO_LOW_m<-with(df_describe,as.numeric(by(rpd_fore_perID_lowUT,interaction(groupASD,groupADHD),function(x){round(mean(x,na.rm=T),3)})))
rpd_TO_LOW_sd<-with(df_describe,as.numeric(by(rpd_fore_perID_lowUT,interaction(groupASD,groupADHD),function(x){round(sd(x,na.rm=T),3)})))

rpd_fore_perID_highUT<-as.numeric(with(df_trial[df_trial$typeGame=='high-utility',],by(rpd_fore,id.label,mean,na.rm=T)))
rpd_TO_HIGH_m<-with(df_describe,as.numeric(by(rpd_fore_perID_highUT,interaction(groupASD,groupADHD),function(x){round(mean(x,na.rm=T),3)})))
rpd_TO_HIGH_sd<-with(df_describe,as.numeric(by(rpd_fore_perID_highUT,interaction(groupASD,groupADHD),function(x){round(sd(x,na.rm=T),3)})))

### phasic response (rpd_phasic)
rpd_phasic_perID_lowUT<-as.numeric(with(df_trial[df_trial$typeGame=='low-utility',],by(rpd_phasic,id.label,mean,na.rm=T)))
rpd_PH_LOW_m<-with(df_describe,as.numeric(by(rpd_phasic_perID_lowUT,interaction(groupASD,groupADHD),function(x){round(mean(x,na.rm=T),3)})))
rpd_PH_LOW_sd<-with(df_describe,as.numeric(by(rpd_phasic_perID_lowUT,interaction(groupASD,groupADHD),function(x){round(sd(x,na.rm=T),3)})))

rpd_phasic_perID_highUT<-as.numeric(with(df_trial[df_trial$typeGame=='high-utility',],by(rpd_phasic,id.label,mean,na.rm=T)))
rpd_PH_HIGH_m<-with(df_describe,as.numeric(by(rpd_phasic_perID_highUT,interaction(groupASD,groupADHD),function(x){round(mean(x,na.rm=T),3)})))
rpd_PH_HIGH_sd<-with(df_describe,as.numeric(by(rpd_phasic_perID_highUT,interaction(groupASD,groupADHD),function(x){round(sd(x,na.rm=T),3)})))

### reaction time (rt_m)
rt_lowUT<-as.numeric(with(df_trial[df_trial$typeGame=='low-utility',],by(rt_m,id.label,mean,na.rm=T)))
rt_LOW_m<-with(df_describe,as.numeric(by(rt_lowUT,interaction(groupASD,groupADHD),function(x){round(mean(x,na.rm=T),0)})))
rt_LOW_sd<-with(df_describe,as.numeric(by(rt_lowUT,interaction(groupASD,groupADHD),function(x){round(sd(x,na.rm=T),0)})))
rt_highUT<-as.numeric(with(df_trial[df_trial$typeGame=='high-utility',],by(rt_m,id.label,mean,na.rm=T)))
rt_HIGH_m<-with(df_describe,as.numeric(by(rt_highUT,interaction(groupASD,groupADHD),function(x){round(mean(x,na.rm=T),0)})))
rt_HIGH_sd<-with(df_describe,as.numeric(by(rt_highUT,interaction(groupASD,groupADHD),function(x){round(sd(x,na.rm=T),0)})))

baseline_low<-paste(rpd_TO_LOW_m,rpd_TO_LOW_sd,sep='/') 
baseline_high<-paste(rpd_TO_HIGH_m,rpd_TO_HIGH_sd,sep='/') 
sepr_low<-paste(rpd_PH_LOW_m,rpd_PH_LOW_sd,sep='/') 
sepr_high<-paste(rpd_PH_HIGH_m,rpd_PH_HIGH_sd,sep='/') 
rt_low<-paste(rt_LOW_m,rt_LOW_sd,sep='/')
rt_high<-paste(rt_HIGH_m,rt_HIGH_sd,sep='/')

attach(df_describe)
#main demographics
n_obs<-as.numeric(table(interaction(groupASD,groupADHD)))
age_m<-as.numeric(by(age,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
vIQ_m<-as.numeric(by(vIQ,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
pIQ_m<-as.numeric(by(pIQ,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
age_sd<-as.numeric(by(age,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
vIQ_sd<-as.numeric(by(vIQ,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
pIQ_sd<-as.numeric(by(pIQ,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
age<-paste(age_m,age_sd,sep='/')
vIQ<-paste(vIQ_m,vIQ_sd,sep='/')
pIQ<-paste(pIQ_m,pIQ_sd,sep='/')
gender_table<-sapply(by(sex,interaction(groupASD,groupADHD),table),c)  #-->more female in TD  
gender_ratio<-paste(gender_table[1,],gender_table[2,],sep='/')
  
#questionnaire data
cbcl_m<-as.numeric(by(CBCL_t,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
fsk_m<-as.numeric(by(FSK_sum,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
srs_m<-as.numeric(by(SRS_sum,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
inatt_m<-as.numeric(by(INATT_sum,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
hyp_m<-as.numeric(by(HYP_sum,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
cbcl_sd<-as.numeric(by(CBCL_t,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
fsk_sd<-as.numeric(by(FSK_sum,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
srs_sd<-as.numeric(by(SRS_sum,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
inatt_sd<-as.numeric(by(INATT_sum,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
hyp_sd<-as.numeric(by(HYP_sum,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
cbcl<-paste(cbcl_m,cbcl_sd,sep='/')
fsk<-paste(fsk_m,fsk_sd,sep='/')
srs<-paste(srs_m,srs_sd,sep='/')
inatt<-paste(inatt_m,inatt_sd,sep='/')
hyp<-paste(hyp_m,hyp_sd,sep='/')

#task duration (added 18.05.20, calculated from df and not df_describe)
task_duration<-as.numeric(with(df,by(ts.var,id.label,
           function(x){((max(x)-min(x))*33.33)/1000/60})))
taskdur_m<-as.numeric(by(task_duration,interaction(groupASD,groupADHD),function(x){round(mean(x),2)}))  
taskdur_sd<-as.numeric(by(task_duration,interaction(groupASD,groupADHD),function(x){round(sd(x),2)}))  
taskdur<-paste(taskdur_m,taskdur_sd,sep='/')

#concatenate data to one df
dependent_var_data<-data.frame(rbind(baseline_low,baseline_high,sepr_low,sepr_high,rt_low,rt_high))
sample_describe_data<-data.frame(rbind(n_obs,taskdur,age,vIQ,pIQ,gender_ratio,cbcl,fsk,srs,inatt,hyp))
sample_describe_data<-rbind(sample_describe_data,dependent_var_data)

  #Group differences

# with(df_describe,chisq.test(sex,intertaction(groupASD,groupADHD)))
# 

  # plot(TukeyHSD(with(df_describe,aov(task_duration~groupASD*groupADHD))))
  # plot(TukeyHSD(with(df_describe,aov(age~groupASD*groupADHD))))
  # plot(TukeyHSD(with(df_describe,aov(vIQ~groupASD*groupADHD))))
  # plot(TukeyHSD(with(df_describe,aov(pIQ~groupASD*groupADHD))))
  # 
  # plot(TukeyHSD(with(df_describe,aov(CBCL_t~groupASD*groupADHD))))
  # plot(TukeyHSD(with(df_describe,aov(FSK_sum~groupASD*groupADHD))))
  # plot(TukeyHSD(with(df_describe,aov(SRS_sum~groupASD*groupADHD))))
  # plot(TukeyHSD(with(df_describe,aov(INATT_sum~groupASD*groupADHD))))
  # plot(TukeyHSD(with(df_describe,aov(HYP_sum~groupASD*groupADHD))))
  # 
  # 
  #TukeyHSD(with(df_describe,aov(rpd_fore_perID_lowUT~groupASD*groupADHD)))
  #TukeyHSD(with(df_describe,aov(rpd_fore_perID_highUT~groupASD*groupADHD)))
  #TukeyHSD(with(df_describe,aov(rpd_phasic_perID_lowUT~groupASD*groupADHD)))
  #TukeyHSD(with(df_describe,aov(rpd_phasic_perID_highUT~groupASD*groupADHD)))
  #TukeyHSD(with(df_describe,aov(rt_lowUT~groupASD*groupADHD)))
  #TukeyHSD(with(df_describe,aov(rt_highUT~groupASD*groupADHD)))
  
  group_differences<-c('(ADHD-|TD) > (ASD-|ASD+ADHD)', #N
                       '-', #task duration
                       '-', #age
                       '-', #iq verbal
                       '-', #iq perf
                      'TD > (ASD-|ADHD-|ASD+ADHD)', #gender
                      'ASD+ADHD > (ASD-|ADHD-) > TD', #CBCL
                      '(ASD-|ASD+ADHD) > (ADHD-|TD)', #SCQ
                      '(ASD-|ASD+ADHD) > (ADHD-|TD)', #SRS
                      '(ADHD-|ASD+ADHD) > (ASD-|TD)', #ADHD inatt
                      '(ADHD-|ASD+ADHD) > (ASD-|TD)', #ADHD hyp
                      '-', #baseline low
                      '(ASD-|ASD+ADHD) > TD', #baseline high
                      '-', #phasic low
                      '-', #phasic high
                      '-', #rt low
                      '-') #rt high 
                                      
    
detach(df_describe)
#demographics
#by(sex,interaction(groupASD,groupADHD),table)  #-->more female in TD  
```

```{r sampel_descriptive_table,  results='asis'}
row_labels<-c('N','Task duration (in min)','Age (in y)','IQ verbal','IQ performance','Gender',
              'CBCL','SCQ','SRS','ADHD inatt.','ADHD hyp.',
              'BPS (baseline)','BPS (fast/incentive)','SEPR (baseline)','SEPR (fast/incentive)',
              'Reaction time (in ms, baseline)','Reaction time (in ms, fast/incentive)'
              )

sample_describe_data<-sample_describe_data[,c(3,2,1,4)] #column sorting 'ASD-','ADHD-','ASD+ADHD','TD'
sample_describe_data<-cbind(row_labels,sample_describe_data,group_differences)

apa_table(sample_describe_data, 
          font_size = 'footnotesize',
          row.names=F,
          landscape = T,
          caption = 'Sample descriptives.',
          col.names=c('','ASD-','ADHD-','ASD+ADHD','TD','Group differences'),
          note = "m/SD or F/M for gender. ASD = Autism Spectrum Disorder, ADHD = Attention Deficit Hyperactivity Disorder, CBCL = Child Behavior Checklist t-score, SCQ = Social Communication Questionnaire sum score, SRS = Social Responsiveness Scale sum score, ADHD inatt. = DSM-V ADHD rating scale - inattention subscale, ADHD hyp. = DSM-V ADHD rating scale - hyperactivity/impulsivity subscale, BPS = baseline pupil size, SEPR = stimulus-evoked pupillary response, baseline = task condition with low task utility, fast/incentive = task condition with high task utility. BPS and SEPR are normalized by the pupil size of the first 200ms of each task trial. Group differences are calculated descriptively by Tukey HSD or Chi-square test."  
)
```

##Dependent variable distribution (figure 2)

```{r dependent_variables_distribution_plot}

group_new<-with(df_trial,interaction(groupASD,groupADHD))
levels(group_new)<-c('ASD+ADHD','ADHD-','ASD-','TD')
condition<-df_trial$typeGame
df_trial<-data.frame(df_trial,group_new,condition)

g1<-ggplot(df_trial,aes(x=rpd_fore,fill=condition))+
  theme_bw()+
  geom_density(alpha=0.5)+
  facet_grid(~group_new)+
  xlab('baseline pupil size (BPS, scaled)')

g2<-ggplot(df_trial,aes(x=rpd_phasic,fill=condition))+
  theme_bw()+
  geom_density(alpha=0.5)+
  facet_grid(~group_new)+
  xlab('stimulus-evoked pupillary response (SEPR, scaled)')

g3<-ggplot(df_trial,aes(x=rt_m,fill=condition))+
  theme_bw()+
  geom_density(alpha=0.5)+
  facet_grid(~group_new)+
  xlab('mean reaction time (MRT, ms)')

  g_legend<-function(x){
    tmp <- ggplot_gtable(ggplot_build(x))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)}
  
  mylegend<-g_legend(g1)


path_figure2 <- paste(getwd(),'/figure2_DV_distribution.tiff',sep='')

tiff(filename = path_figure2,
     width = 10, height = 8, units = "in", pointsize = 12, res=300, compression="lzw")

grid.arrange(
  arrangeGrob(
    g1 + theme(legend.position="none"),
    g2 + theme(legend.position="none"),
    g3 + theme(legend.position="none"),nrow=3),
  mylegend, ncol=2, widths=c(10,1))
   
dev.off()

```

(ref:figure-caption-2) Gaussian density distribution of the main dependent variables BPS, SEPR, MRT.

```{r plot_figure2_DV_distribution, echo=FALSE, fig.width=10, fig.height=8, fig.cap="(ref:figure-caption-2)"}
grid.arrange(g1,g2,g3,nrow=3)

```

## Arousal Regulation between groups
### BPS (basline pupil size, rpd_fore)

```{r BPS_effects}

lmm_tpd<-lmer(scale(rpd_fore)~groupASD*groupADHD*typeGame+sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)

  #group difference within conditions (02.06.20)
  posthoc_tpd<-emmeans(lmm_tpd,~groupASD+groupADHD|typeGame)
  data.frame(lapply(data.frame(confint(contrast(posthoc_tpd,method='eff'))),
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

  #predicted marginalized means
  posthoc_tpd<-emmeans(lmm_tpd,~typeGame|groupASD+groupADHD)
  data.frame(lapply(data.frame(confint(contrast(posthoc_tpd,method='revpairwise'))),
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

  #model effects
  cbind(round(fixef(lmm_tpd)['typeGamehigh-utility'],2),
        round(confint(lmm_tpd,parm = 'typeGamehigh-utility'),2))
  
```

### SEPR (stimulus-evoked pupillary response, rpd_phasic)

```{r SEPR_effects}

lmm_rpd<-lmer(scale(rpd_phasic)~groupASD*groupADHD*typeGame+sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)

  #group difference within conditions (02.06.20)
  posthoc_rpd<-emmeans(lmm_rpd,~groupASD+groupADHD|typeGame)
  data.frame(lapply(data.frame(confint(contrast(posthoc_rpd,method='eff'))),
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

  #predicted marginalized means (change between conditions) 
  posthoc_rpd<-emmeans(lmm_rpd,~typeGame|groupASD+groupADHD)
  data.frame(lapply(data.frame(confint(contrast(posthoc_rpd,method='revpairwise'))),
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

  #model effects
  cbind(round(fixef(lmm_rpd)['typeGamehigh-utility'],2),
        round(confint(lmm_rpd,parm = 'typeGamehigh-utility'),2))
  
  cbind(round(fixef(lmm_rpd)['scale(age)'],2),
        round(confint(lmm_rpd,parm = 'scale(age)'),2))

```
```{r calculate_PD_figure3}

#BPS
  lmm_contrast_data<-data.frame(plot(contrast(posthoc_tpd,method='revpairwise'))[[1]])
  lmm_contrast_data$group<-as.factor(1:4)
  levels(lmm_contrast_data$group)<-c('ASD+ADHD','ADHD-','ASD-','TD')
  
  g3<-ggplot(lmm_contrast_data,aes(x=group,y=the.emmean))+
    theme_bw()+
    geom_point()+
    geom_errorbar(aes(ymin=asymp.LCL,ymax=asymp.UCL),width=0.2)+ #add conventional error bars
    theme(axis.title.x=element_blank())+
    geom_hline(yintercept=0,lty=2)+
    ylim(-0.5,0.1)+
    labs(y='BPS change',title='A.)')

#SEPR    
  lmm_contrast_data<-data.frame(plot(contrast(posthoc_rpd,method='revpairwise'))[[1]])
  lmm_contrast_data$group<-as.factor(1:4)
  levels(lmm_contrast_data$group)<-c('ASD+ADHD','ADHD-','ASD-','TD')
  
  g4<-ggplot(lmm_contrast_data,aes(x=group,y=the.emmean))+
    theme_bw()+
    geom_point()+
    geom_errorbar(aes(ymin=asymp.LCL,ymax=asymp.UCL),width=0.2)+ #add conventional error bars
    theme(axis.title.x=element_blank())+
    geom_hline(yintercept=0,lty=2)+
    ylim(-0.1,0.5)+
    labs(y='SEPR change',title='B.)')

  path_figure3 <- paste(getwd(),'/figure3_PD_groups.tiff',sep='')
  
  tiff(filename = path_figure3,
       width = 7, height = 3.5, units = "in", pointsize = 12, res=300, compression="lzw")

  grid.arrange(g3,g4,layout_matrix= matrix(c(1,2),nrow=1,ncol=2))
 
  # tiff(filename = path_figure2, 
  #      width = 3.5, height = 3, units = "in", pointsize = 12, res=300, compression="lzw")
  # 
  # g3
  # 
  dev.off()
```

(ref:figure-caption-3) Arousal regulation (BPS, SEPR) between conditions (high-utility - low-utility contrast). Smaller change in Baseline Pupil Size (BPS) in the ASD groups (left). No change in stimulus-evoked pupillary response (SEPR) that is specific to the ASD- group (right).

```{r plot_figure3_PD, echo=FALSE, fig.width=7, fig.height=3.5, fig.cap="(ref:figure-caption-3)"}
#g3
grid.arrange(g3,g4,layout_matrix= matrix(c(1,2),nrow=1,ncol=2))

#change

```

## Reaction time performance

```{r reaction_time_effects}

#model effects  
  lmm_trial<-lmer(scale(rt_m)~groupASD*groupADHD*typeGame+sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)

cbind(round(fixef(lmm_trial)['typeGamehigh-utility'],2),
      round(confint(lmm_trial,parm = 'typeGamehigh-utility'),2))

cbind(round(fixef(lmm_trial)['scale(age)'],2),
      round(confint(lmm_trial,parm = 'scale(age)'),2))

cbind(round(fixef(lmm_trial)['scale(pIQ)'],2),
      round(confint(lmm_trial,parm = 'scale(pIQ)'),2))

#reaction time difference between groups within conditions (19.05.20)
  posthoc<-emmeans(lmm_trial,~groupASD+groupADHD|typeGame)
  data.frame(lapply(data.frame(confint(contrast(posthoc,method='eff'))),
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

#predicted marginalized means
  posthoc<-emmeans(lmm_trial,~typeGame|groupASD+groupADHD)
  data.frame(lapply(data.frame(confint(contrast(posthoc,method='revpairwise'))),
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

```

```{r calculate_reaction_time_figure_and_save_to_file, warning=FALSE}

  #redefine levels for facet labels
  df_trial_fig3<-df_trial
  levels(df_trial_fig3$typeGame)<-c("baseline condition (low utility)","fast/incentive condition (high utility)")

    #contrast as ggplots
  lmm_trial<-lmer(rt_m~groupASD*groupADHD*typeGame+sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial_fig3)
  
  posthoc<-emmeans(lmm_trial,~groupASD*groupADHD|typeGame)
  g1<-plot(posthoc,horizontal=F,CIs=F)+
      theme_bw()+
      geom_errorbar(aes(ymin=asymp.LCL,ymax=asymp.UCL),width=0.2)+ #add conventional error bars
      facet_grid(. ~typeGame)+ #facet labels change
      theme(axis.title.x=element_blank())+
      labs(y='mean reaction time (ms)',title='A.)')+
      scale_x_discrete(labels = c("ASD ADHD" = "ASD+ADHD","no_ASD ADHD" = "ADHD-","ASD no_ADHD" = "ASD-","no_ASD no_ADHD" = "TD"))
    
  # posthoc<-emmeans(lmm_trial,~typeGame|groupASD+groupADHD)
  # plot(contrast(posthoc,method='pairwise'),horizontal=F,CI=F)+
  #   theme_bw()+
  #   geom_errorbar(aes(ymin=asymp.LCL,ymax=asymp.UCL),width=0.2)+ #add conventional error bars
  #   facet_grid(. ~groupASD+groupADHD)+ #facet labels change
  #   labs(x='contrast',y='reaction time difference (ms)')
   
  #we extract the data from the contrast to allow better plotting
  posthoc<-emmeans(lmm_trial,~typeGame|groupASD+groupADHD)
  lmm_contrast_data<-data.frame(plot(contrast(posthoc,method='revpairwise'))[[1]])
  lmm_contrast_data$group<-as.factor(1:4)
  levels(lmm_contrast_data$group)<-c('ASD+ADHD','ADHD-','ASD-','TD')
  
  g2<-ggplot(lmm_contrast_data,aes(x=group,y=the.emmean))+
    theme_bw()+
    geom_point()+
    geom_errorbar(aes(ymin=asymp.LCL,ymax=asymp.UCL),width=0.2)+ #add conventional error bars
    theme(axis.title.x=element_blank())+
    labs(y='reaction time difference (ms)',title='B.)')
  
  path_figure4 <- paste(getwd(),'/figure4_reaction_time.tiff',sep='')
  
  tiff(filename = path_figure4, 
       width = 9, height = 3, units = "in", pointsize = 12, res=300, compression="lzw")
  
  grid.arrange(g1,g2,layout_matrix= matrix(c(1,1,2),nrow=1,ncol=3))
  
  dev.off()

```

(ref:figure-caption-4) Reaction Time Performance between groups.

```{r plot_figure4_RT, echo=FALSE, fig.width=9, fig.height=3, fig.cap="(ref:figure-caption-4)"}
#knitr::include_graphics(path_figure1)
grid.arrange(g1,g2,layout_matrix= matrix(c(1,1,2),nrow=1,ncol=3))

```


## Arousal regulation of reaction time performance

```{r reaction_time_by_arousal_regulation_calculate_model}

     # lmm_trial_int<-lmer(scale(rt_m)~typeGame*groupASD*groupADHD+
     #                        scale(rpd_fore)+
     #                        scale(rpd_phasic)+
     #                        groupASD:scale(rpd_fore)+
     #                        groupASD:scale(rpd_phasic)+
     #                        groupADHD:scale(rpd_fore)+
     #                        groupADHD:scale(rpd_phasic)+
     #                        groupASD:groupADHD:scale(rpd_fore)+
     #                        groupASD:groupADHD:scale(rpd_phasic)+
     #                        typeGame:groupASD:groupADHD:scale(rpd_fore)+
     #                        typeGame:groupASD:groupADHD:scale(rpd_phasic)+
     #            sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)

   lmm_trial_int<-lmer(scale(rt_m)~typeGame*groupASD*groupADHD+
                            scale(rpd_fore)+
                            scale(rpd_phasic)+
                            typeGame:scale(rpd_fore)+
                            typeGame:scale(rpd_phasic)+
                            groupASD:scale(rpd_fore)+
                            groupASD:scale(rpd_phasic)+
                            groupADHD:scale(rpd_fore)+
                            groupADHD:scale(rpd_phasic)+
                            groupASD:groupADHD:scale(rpd_fore)+
                            groupASD:groupADHD:scale(rpd_phasic)+
                            typeGame:groupASD:scale(rpd_fore)+
                            typeGame:groupASD:scale(rpd_phasic)+
                            typeGame:groupADHD:scale(rpd_fore)+
                            typeGame:groupADHD:scale(rpd_phasic)+
                            typeGame:groupASD:groupADHD:scale(rpd_fore)+
                            typeGame:groupASD:groupADHD:scale(rpd_phasic)+
                sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)


```

### Overall effects of BPS and SEPR on MRT

```{r BPS_SEPR_on_MRT}
 #overall effects
  cbind(round(fixef(lmm_trial_int)['scale(rpd_fore)'],2),
        round(confint(lmm_trial_int,parm = 'scale(rpd_fore)'),2))
  
 posthoc<-data.frame(emtrends(lmm_trial_int,~typeGame,var='rpd_fore'))
  data.frame(lapply(posthoc,
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

  cbind(round(fixef(lmm_trial_int)['scale(rpd_phasic)'],2),
        round(confint(lmm_trial_int,parm = 'scale(rpd_phasic)'),2))
  
 posthoc<-data.frame(emtrends(lmm_trial_int,~typeGame,var='rpd_phasic'))
  data.frame(lapply(posthoc,
                    function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

  
```

### Different effects of BPS and SEPR on MRT between groups 

```{r RTxPD_emtrends}
  #predicted marginalized means
    
    print('ASD x ADHD x BPS interaction')
    posthoc<-data.frame(emtrends(lmm_trial_int,~groupASD+groupADHD,var='rpd_fore'))
    data.frame(lapply(posthoc,
                      function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values

    print('ADHD x condition x BPS interaction')
    posthoc<-emtrends(lmm_trial_int,~typeGame|groupASD+groupADHD,var='rpd_fore')
    data.frame(lapply(data.frame(confint(contrast(posthoc,method='revpairwise'))),
                  function(y) if(is.numeric(y)) round(y, 2) else y)) #round numeric values
        
    print('ASD x SEPR interaction')
    posthoc<-data.frame(emtrends(lmm_trial_int,~groupASD+groupADHD,var='rpd_phasic'))
    data.frame(lapply(posthoc,
                      function(y) if(is.numeric(y)) round(y, 2) else y)) 

    
```

```{r  calculate_RTxPD_figure5_and_save_to_file}
path_figure5 <- paste(getwd(),'/figure5_arousal_regulation_of_reaction_time.tiff',sep='')

tiff(filename = path_figure5, 
     width = 7, height = 3, units = "in", pointsize = 12, res=300, compression="lzw")

g8<-plot_model(lmm_trial_int, type = "pred", terms = c("rpd_fore",'typeGame'))+
  theme_bw()+labs(x='BPS (scaled)',y='mean reaction time (scaled)',title='')+
  theme(legend.position = "none")
g9<-plot_model(lmm_trial_int, type = "pred", terms = c("rpd_phasic",'typeGame'))+
  theme_bw()+labs(x='SEPR (scaled)',y='mean reaction time (scaled)',title='')+
  labs(color='condition')+ #new legend title
  theme(axis.title.y=element_blank())
  
grid.arrange(g8,g9,layout_matrix= matrix(c(1,1,1,1,2,2,2,2,2),nrow=1,ncol=9))

dev.off()
```

```{r plot_figure5, fig.width=7, fig.height=3, fig.cap="Arousal Regulation (BPS, SEPR) of Reaction Time"}

 grid.arrange(g8,g9,layout_matrix= matrix(c(1,1,1,1,2,2,2,2,2),nrow=1,ncol=9))
  
```

## Tables

tables are printed at the end of the document.

```{r table_tonic_PD_model, results='asis'}
lmm_tpd<-lmer(scale(rpd_fore)~groupASD*groupADHD*typeGame+sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)
  
lmm_tpd_data<-anova(lmm_tpd)  
  lmm_tpd_data<-lmm_tpd_data[,-2]
  row.names(lmm_tpd_data)<-c('ASD','ADHD','condition','gender','age','IQp','ASD x ADHD','ASD x condition','ADHD x condition','ASD x ADHD x condition')

  #add p-adjusted values
  lmm_tpd_data$p_adj<-sapply(lmm_tpd_data$`Pr(>F)`,function(x){round(p.adjust(x,'bonferroni',number_of_models),3)})
  
apa_table(lmm_tpd_data, 
          digits=c(0,2,0,0,2,3,3),
          caption = 'Linear mixed model: Baseline pupil size (BPS)',
          col.names=c('','Sum Sq','DF (num)','DF (den)','F-value','p-value','p-adj.'),
          note = "ASD = Autism Spectrum Disorder. ADHD = Attention Deficit Hyperactivity Disorder. condition = task condition (baseline vs fast/incentive). IQp = performance IQ."
)  
  
```

```{r table_phasic_PD_model, results='asis'}
lmm_rpd<-lmer(scale(rpd_phasic)~groupASD*groupADHD*typeGame+sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)
lmm_rpd_data<-anova(lmm_rpd)  
  lmm_rpd_data<-lmm_rpd_data[,-2]
  row.names(lmm_rpd_data)<-c('ASD','ADHD','condition','gender','age','IQp','ASD x ADHD','ASD x condition','ADHD x condition','ASD x ADHD x condition')
  
   #add p-adjusted values
  lmm_rpd_data$p_adj<-sapply(lmm_rpd_data$`Pr(>F)`,function(x){round(p.adjust(x,'bonferroni',number_of_models),3)})

apa_table(lmm_rpd_data, 
          digits=c(0,2,0,0,2,3,3),
          caption = 'Linear mixed model: Stimulus-evoked pupillary response (SEPR)',
          col.names=c('','Sum Sq','DF (num)','DF (den)','F-value','p-value','p-adj.'),
          note = "ASD = Autism Spectrum Disorder. ADHD = Attention Deficit Hyperactivity Disorder. condition = task condition (baseline vs fast/incentive). IQp = performance IQ."
)  
```

```{r table_reaction_time_model, results='asis'}
  lmm_rt<-lmer(scale(rt_m)~groupASD*groupADHD*typeGame+sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)
lmm_rt_data<-anova(lmm_rt)  
  lmm_rt_data<-lmm_rt_data[,-2]
  row.names(lmm_rt_data)<-c('ASD','ADHD','condition','gender','age','IQp','ASD x ADHD','ASD x condition','ADHD x condition','ASD x ADHD x condition')
  
    #add p-adjusted values
  lmm_rt_data$p_adj<-sapply(lmm_rt_data$`Pr(>F)`,function(x){round(p.adjust(x,'bonferroni',number_of_models),3)})

apa_table(lmm_rt_data, 
          digits=c(0,2,0,0,2,3,3),
          caption = 'Linear mixed model: Mean reaction time (MRT)',
          col.names=c('','Sum Sq','DF (num)','DF (den)','F-value','p-value','p-adj.'),
          note = "ASD = Autism Spectrum Disorder. ADHD = Attention Deficit Hyperactivity Disorder. condition = task condition (baseline vs fast/incentive). IQp = performance IQ."
)  
  
```

```{r table_reaction_time_by_arousal_regulation, results='asis'}

    lmm_trial_int<-lmer(scale(rt_m)~typeGame*groupASD*groupADHD+
                            scale(rpd_fore)+
                            scale(rpd_phasic)+
                            typeGame:scale(rpd_fore)+
                            typeGame:scale(rpd_phasic)+
                            groupASD:scale(rpd_fore)+
                            groupASD:scale(rpd_phasic)+
                            groupADHD:scale(rpd_fore)+
                            groupADHD:scale(rpd_phasic)+
                            groupASD:groupADHD:scale(rpd_fore)+
                            groupASD:groupADHD:scale(rpd_phasic)+
                            typeGame:groupASD:scale(rpd_fore)+
                            typeGame:groupASD:scale(rpd_phasic)+
                            typeGame:groupADHD:scale(rpd_fore)+
                            typeGame:groupADHD:scale(rpd_phasic)+
                            typeGame:groupASD:groupADHD:scale(rpd_fore)+
                            typeGame:groupASD:groupADHD:scale(rpd_phasic)+
                sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)

# lmm_trial_int<-lmer(scale(rt_m)~typeGame*groupASD*groupADHD*rpd_fore*rpd_phasic+
#                       sex+scale(age)+scale(pIQ)+(1|id.label)+(1|currentTrial),data=df_trial)

lmm_RTxPD_data<-anova(lmm_trial_int)  
  lmm_RTxPD_data<-lmm_RTxPD_data[,-2]
  row.names(lmm_RTxPD_data)<-c(
    'condition','ASD','ADHD','BPS','SEPR','gender','age','IQp','ASD x condition','ADHD x condition',
    'ASD x ADHD','condition x BPS','condition x SEPR',
    'ASD x BPS','ASD x SEPR','ADHD x BPS','ADHD x SEPR',
    'ASD x ADHD x condition','ASD x ADHD x BPS','ASD x ADHD x SEPR','ASD x condition x BPS',
    'ASD x condition x SEPR','ADHD x condition x BPS','ADHD x condition x SEPR',
    'ASD x ADHD x condition x BPS', 'ASD x ADHD x condition x SEPR')
  
  # row.names(lmm_RTxPD_data)<-c(
  #   'condition','ASD','ADHD','BPS','SEPR','gender','age','IQp','condition x BPS','condition x SEPR',
  #   'ASD x condition','ADHD x condition','ASD x ADHD','ASD x BPS','ASD x SEPR','ADHD x BPS','ADHD x SEPR',
  #   'ASD x ADHD x condition','ASD x ADHD x BPS','ASD x ADHD x SEPR','ASD x condition x BPS',
  #   'ASD x condition x SEPR','ADHD x condition x BPS','ADHD x condition x SEPR',
  #   'ASD x ADHD x condition x BPS', 'ASD x ADHD x condition x SEPR')
  # 
  
  
  # row.names(lmm_RTxPD_data)<-c('condition','ASD','ADHD','BPS','SEPR','gender','age','IQp','ASD x condition','ADHD x condition','ASD x ADHD','condition x BPS','ASD x BPS','ADHD x BPS','condition x SEPR','ASD x SEPR','ADHD x SEPR','BPS x SEPR','ASD x ADHD x condition','ASD x condition x BPS','ADHD x condition x BPS', 'ASD x ADHD x BPS','ASD x condition x SEPR','ADHD x condition x SEPR','ASD x ADHD x SEPR','condition x BPS x SEPR ','ASD x BPS x SEPR','ADHD x BPS x SEPR','ASD x ADHD x cond. x BPS', 'ASD x ADHD x cond. x SEPR','ASD x cond. x BPS x SEPR','ADHD x cond. x BPS x SEPR','ASD x ADHD x BPS x SEPR','ASD x ADHD x cond. x BPS x SEPR')

    #add p-adjusted values
  lmm_RTxPD_data$p_adj<-sapply(lmm_RTxPD_data$`Pr(>F)`,function(x){round(p.adjust(x,'bonferroni',number_of_models),3)})
  
apa_table(lmm_RTxPD_data, 
          digits=c(0,2,0,0,2,3,3),
          caption = 'Linear mixed model: Mean reaction time (MRT) by arousal regulation (BPS, SEPR)',
          col.names=c('','Sum Sq','DF (num)','DF (den)','F-value','p-value','p-adj.'),
          longtable=T, #table can be printed in pdf across pages
          font_size="footnotesize", #reduce size of text
          note = "ASD = Autism Spectrum Disorder. ADHD = Attention Deficit Hyperactivity Disorder. BPS = baseline pupil size. SEPR = stimulus-evoked pupillary response. condition = task condition (baseline vs fast/incentive). IQp = performance IQ."

)  

# apa_table(lmm_RTxPD_data[18:34,], 
#           digits=c(0,2,0,0,2,3,3),
#           caption = 'Linear mixed model: Mean reaction time (MRT) by arousal regulation (BPS, SEPR)',
#           col.names=c('','Sum Sq','DF (num)','DF (den)','F-value','p-value','p-adj.')
# )  


```

\newpage

# References
```{r create_r-references}
r_refs(file = "r-references.bib")
```

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup
